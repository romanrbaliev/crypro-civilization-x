
import { GameState } from '../types';
import { initialState } from '../initialState';
import { isTelegramCloudStorageAvailable, forceTelegramCloudSave, forceTelegramCloudLoad } from '@/utils/helpers';

// –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∞ —Å –∏–º–µ–Ω–µ–º –∫–ª—é—á–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
export const GAME_STORAGE_KEY = 'cryptoCivilizationSave';

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ localStorage
const isLocalStorageAvailable = () => {
  try {
    const testKey = '__test__';
    localStorage.setItem(testKey, testKey);
    localStorage.removeItem(testKey);
    return true;
  } catch (e) {
    console.warn('localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ:', e);
    return false;
  }
};

// –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è —Å—Ä–µ–¥, –≥–¥–µ localStorage –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
// –°–¥–µ–ª–∞–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–º –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω—è–ª–æ—Å—å –¥–∞–∂–µ –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
let memoryStorage: Record<string, string> = {};

// –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Ä–µ—Ç—Ä–∞—è–º–∏ –¥–ª—è Telegram
const saveItem = async (key: string, value: string, retries = 3): Promise<boolean> => {
  try {
    console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä—ã (—Ä–∞–∑–º–µ—Ä: ${value.length} –±–∞–π—Ç)...`);
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º Telegram Cloud Storage, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    if (isTelegramCloudStorageAvailable()) {
      try {
        console.log('üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Telegram CloudStorage...');
        const saved = await forceTelegramCloudSave(value, key);
        
        if (saved) {
          console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Telegram CloudStorage');
          // –î—É–±–ª–∏—Ä—É–µ–º –≤ localStorage –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          if (isLocalStorageAvailable()) {
            try {
              localStorage.setItem(key, value);
              console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Ç–∞–∫–∂–µ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω—ã –≤ localStorage');
            } catch (e) {
              console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ localStorage:', e);
            }
          }
          return true;
        } else if (retries > 0) {
          console.warn(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Telegram, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ (–æ—Å—Ç–∞–ª–æ—Å—å ${retries})...`);
          // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
          await new Promise(resolve => setTimeout(resolve, 500));
          return saveItem(key, value, retries - 1);
        }
      } catch (telegramError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ Telegram CloudStorage:', telegramError);
        if (retries > 0) {
          console.warn(`‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–æ—Å—Ç–∞–ª–æ—Å—å ${retries})...`);
          // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
          await new Promise(resolve => setTimeout(resolve, 500));
          return saveItem(key, value, retries - 1);
        }
      }
    }
    
    // –ó–∞—Ç–µ–º –ø—Ä–æ–±—É–µ–º localStorage
    if (isLocalStorageAvailable()) {
      try {
        localStorage.setItem(key, value);
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ localStorage');
        return true;
      } catch (localStorageError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ localStorage:', localStorageError);
      }
    }

    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–º—è—Ç—å
    memoryStorage[key] = value;
    console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç–∏ (–≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ)');
    return true;
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    // –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–∞–º—è—Ç—å
    try {
      memoryStorage[key] = value;
      console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ø–∞–º—è—Ç–∏ (–∞–≤–∞—Ä–∏–π–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ)');
      return true;
    } catch (e) {
      console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–∂–µ –≤ –ø–∞–º—è—Ç—å:', e);
      return false;
    }
  }
};

// –û–±–µ—Ä—Ç–∫–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Ä–µ—Ç—Ä–∞—è–º–∏ –¥–ª—è Telegram
const getItem = async (key: string, retries = 3): Promise<string | null> => {
  try {
    console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–≥—Ä—ã (–∫–ª—é—á: ${key})...`);
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º Telegram Cloud Storage, –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω
    if (isTelegramCloudStorageAvailable()) {
      try {
        console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Telegram CloudStorage...');
        const telegramData = await forceTelegramCloudLoad(key);
        
        if (telegramData !== null && telegramData !== '') {
          console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ Telegram CloudStorage (${telegramData.length} –±–∞–π—Ç)`);
          
          // –î—É–±–ª–∏—Ä—É–µ–º –≤ localStorage –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è
          if (isLocalStorageAvailable()) {
            try {
              localStorage.setItem(key, telegramData);
            } catch (e) {
              console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –≤ localStorage:', e);
            }
          }
          
          return telegramData;
        } else if (retries > 0) {
          console.warn(`‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –∏–∑ Telegram –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ (–æ—Å—Ç–∞–ª–æ—Å—å ${retries})...`);
          // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
          await new Promise(resolve => setTimeout(resolve, 500));
          return getItem(key, retries - 1);
        }
      } catch (telegramError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ Telegram CloudStorage:', telegramError);
        if (retries > 0) {
          console.warn(`‚ö†Ô∏è –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–æ—Å—Ç–∞–ª–æ—Å—å ${retries})...`);
          // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π
          await new Promise(resolve => setTimeout(resolve, 500));
          return getItem(key, retries - 1);
        }
      }
    }
    
    // –ó–∞—Ç–µ–º –ø—Ä–æ–±—É–µ–º localStorage
    if (isLocalStorageAvailable()) {
      try {
        const localData = localStorage.getItem(key);
        if (localData !== null && localData !== '') {
          console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ localStorage (${localData.length} –±–∞–π—Ç)`);
          return localData;
        }
      } catch (localStorageError) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑ localStorage:', localStorageError);
      }
    }

    // –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–∞–º—è—Ç—å
    if (memoryStorage[key]) {
      console.log(`‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏ (${memoryStorage[key].length} –±–∞–π—Ç)`);
      return memoryStorage[key];
    }
    
    console.log('‚ùå –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –Ω–∏ –≤ –æ–¥–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ');
    return null;
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
    
    // –í –∫—Ä–∞–π–Ω–µ–º —Å–ª—É—á–∞–µ –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –ø–∞–º—è—Ç–∏
    try {
      if (memoryStorage[key]) {
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ –ø–∞–º—è—Ç–∏ (–∞–≤–∞—Ä–∏–π–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ)');
        return memoryStorage[key];
      }
    } catch (e) {
      console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–∂–µ –∏–∑ –ø–∞–º—è—Ç–∏:', e);
    }
    
    return null;
  }
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
export async function saveGameState(state: GameState): Promise<boolean> {
  try {
    // –û–±–Ω–æ–≤–ª—è–µ–º timestamp –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
    const stateToSave = {
      ...state,
      lastSaved: Date.now() // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –≤—Ä–µ–º–µ–Ω–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    };
    
    const serializedState = JSON.stringify(stateToSave);
    console.log(`üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã (—Ä–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: ${serializedState.length} –±–∞–π—Ç)`);
    
    const success = await saveItem(GAME_STORAGE_KEY, serializedState);
    
    if (success) {
      console.log('‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞:', new Date().toLocaleTimeString());
      return true;
    } else {
      console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–≥—Ä—É');
      return false;
    }
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', error);
    return false;
  }
}

// –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä
function deepMerge(target: any, source: any): any {
  const output = { ...target };
  
  for (const key in source) {
    if (source.hasOwnProperty(key)) {
      if (
        typeof source[key] === 'object' && 
        source[key] !== null &&
        !Array.isArray(source[key])
      ) {
        if (key in target && typeof target[key] === 'object' && target[key] !== null) {
          output[key] = deepMerge(target[key], source[key]);
        } else {
          output[key] = { ...source[key] };
        }
      } else {
        output[key] = source[key];
      }
    }
  }
  
  return output;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
export async function loadGameState(): Promise<GameState | null> {
  try {
    console.log('üîÑ –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π –∏–≥—Ä—ã...');
    const serializedState = await getItem(GAME_STORAGE_KEY);
    
    if (serializedState === null || serializedState === '') {
      console.log('‚ùå –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—É—é –∏–≥—Ä—É');
      return null;
    }
    
    try {
      const loadedState = JSON.parse(serializedState) as GameState;
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã (lastSaved: ${new Date(loadedState.lastSaved || 0).toLocaleTimeString() || '–Ω–µ –∑–∞–¥–∞–Ω–æ'})`);
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª—É–±–æ–∫–æ–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Å–ª–∏—è–Ω–∏—è –≤—Å–µ—Ö –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
      const mergedState = deepMerge(initialState, loadedState);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      mergedState.lastUpdate = Date.now();
      
      console.log('‚úÖ –ò–≥—Ä–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', new Date().toLocaleTimeString());
      return mergedState;
    } catch (parseError) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–±–æ—Ä–µ JSON –¥–∞–Ω–Ω—ã—Ö:', parseError);
      
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞, –ø–æ–ø—Ä–æ–±—É–µ–º –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      try {
        console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...');
        
        // –£–¥–∞–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        await clearGameState();
        
        return null;
      } catch (e) {
        console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ:', e);
        return null;
      }
    }
  } catch (error) {
    console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã:', error);
    return null;
  }
}

// –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä—ã
export async function clearGameState(): Promise<void> {
  try {
    console.log('üîÑ –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π –∏–≥—Ä—ã...');
    
    if (isTelegramCloudStorageAvailable()) {
      try {
        console.log('üîÑ –£–¥–∞–ª–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ Telegram CloudStorage...');
        
        // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
        const metaDataStr = await window.Telegram.WebApp.CloudStorage.getItem(`${GAME_STORAGE_KEY}_meta`);
        
        if (metaDataStr) {
          try {
            const metaData = JSON.parse(metaDataStr);
            console.log(`–ù–∞–π–¥–µ–Ω—ã –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è: —á–∞—Å—Ç–∏=${metaData.total}`);
            
            // –£–¥–∞–ª—è–µ–º –≤—Å–µ —á–∞—Å—Ç–∏
            for (let i = 0; i < metaData.total; i++) {
              await window.Telegram.WebApp.CloudStorage.removeItem(`${GAME_STORAGE_KEY}_${i}`);
              console.log(`–£–¥–∞–ª–µ–Ω–∞ —á–∞—Å—Ç—å ${i+1}/${metaData.total}`);
            }
            
            // –£–¥–∞–ª—è–µ–º –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
            await window.Telegram.WebApp.CloudStorage.removeItem(`${GAME_STORAGE_KEY}_meta`);
            console.log('–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
          } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–∞—Å—Ç–µ–π:', e);
          }
        }
        
        // –£–¥–∞–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –∫–ª—é—á
        await window.Telegram.WebApp.CloudStorage.removeItem(GAME_STORAGE_KEY);
        console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ Telegram CloudStorage');
      } catch (telegramError) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∏–∑ Telegram CloudStorage:', telegramError);
      }
    }
    
    if (isLocalStorageAvailable()) {
      localStorage.removeItem(GAME_STORAGE_KEY);
      console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ localStorage');
    }
    
    delete memoryStorage[GAME_STORAGE_KEY];
    console.log('‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –∏–∑ –ø–∞–º—è—Ç–∏');
    
    console.log('‚úÖ –í—Å–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–≥—Ä—ã —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã');
  } catch (error) {
    console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–≥—Ä—ã:', error);
  }
}
